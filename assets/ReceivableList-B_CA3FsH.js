import{r as x,F as n,j as t,B as v,f as B,R as E,C as r,a as i,M as y,g as A,s as b,T as _,y as z}from"./index-B1irlVr5.js";import{d as S}from"./dayjs.min-CuWnGRVX.js";import{u as K}from"./accountsStore-CoF52nKO.js";import{u as V}from"./financeStore-Cx6ve21G.js";import{S as l}from"./index-DTABTL4s.js";import{F as G}from"./Table-WxZSygbk.js";import{S as H}from"./index-CouCZRz8.js";import{T as N}from"./index-DtubzoSF.js";import{D as J}from"./index-B_DoBQcZ.js";import{R as Q}from"./DollarOutlined-BHCB0DYC.js";function ie(){const{receivables:o,customers:f,addReceivable:I,updateReceivable:D}=K(),{addRecord:M}=V(),[k,d]=x.useState(!1),[F,c]=x.useState(!1),[s,R]=x.useState(null),[u]=n.useForm(),[m]=n.useForm(),j=o.reduce((e,a)=>e+a.amount,0),h=o.reduce((e,a)=>e+a.paidAmount,0),Y=o.filter(e=>e.status==="overdue").reduce((e,a)=>e+(a.amount-a.paidAmount),0),w=()=>{u.resetFields(),d(!0)},C=e=>{R(e),m.setFieldsValue({amount:e.amount-e.paidAmount}),c(!0)},T=()=>{u.validateFields().then(e=>{const a=f.find(p=>p.id===e.customerId);I({...e,id:Date.now().toString(),customerName:(a==null?void 0:a.name)||"",dueDate:e.dueDate.format("YYYY-MM-DD"),paidAmount:0,status:"pending",createdAt:S().format("YYYY-MM-DD")}),b.success("添加成功"),d(!1)})},$=()=>{m.validateFields().then(e=>{if(!s)return;const a=s.paidAmount+e.amount,p=a>=s.amount?"paid":"partial";D(s.id,{paidAmount:a,status:p});const g=S().format("YYYY-MM-DD");M({id:`receivable-${s.id}-${Date.now()}`,type:"income",amount:e.amount,category:"销售收入",description:`应收账款收款 - ${s.customerName} (${s.invoiceNo})`,date:g,createdAt:g}),b.success("收款成功，已自动生成收入记录"),c(!1)})},O=e=>({pending:"blue",partial:"orange",paid:"green",overdue:"red"})[e]||"default",q=e=>({pending:"待收款",partial:"部分收款",paid:"已收款",overdue:"已逾期"})[e]||e,L=[{title:"发票号",dataIndex:"invoiceNo",key:"invoiceNo"},{title:"客户",dataIndex:"customerName",key:"customerName"},{title:"应收金额",dataIndex:"amount",key:"amount",render:e=>`¥${e.toLocaleString()}`},{title:"已收金额",dataIndex:"paidAmount",key:"paidAmount",render:e=>`¥${e.toLocaleString()}`},{title:"待收金额",key:"remaining",render:(e,a)=>t.jsxs("span",{className:"text-red-600",children:["¥",(a.amount-a.paidAmount).toLocaleString()]})},{title:"到期日",dataIndex:"dueDate",key:"dueDate"},{title:"状态",dataIndex:"status",key:"status",render:e=>t.jsx(_,{color:O(e),children:q(e)})},{title:"操作",key:"action",render:(e,a)=>a.status!=="paid"&&t.jsx(z,{action:"update",children:t.jsx(v,{icon:t.jsx(Q,{}),size:"small",type:"primary",onClick:()=>C(a),children:"收款"})})}],P=[{range:"0-30天",amount:o.filter(e=>e.status!=="paid").reduce((e,a)=>e+(a.amount-a.paidAmount),0)*.4},{range:"31-60天",amount:o.filter(e=>e.status!=="paid").reduce((e,a)=>e+(a.amount-a.paidAmount),0)*.3},{range:"61-90天",amount:o.filter(e=>e.status!=="paid").reduce((e,a)=>e+(a.amount-a.paidAmount),0)*.2},{range:"90天以上",amount:o.filter(e=>e.status!=="paid").reduce((e,a)=>e+(a.amount-a.paidAmount),0)*.1}];return t.jsxs("div",{children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h2",{className:"text-xl font-bold",children:"应收账款"}),t.jsx(v,{type:"primary",icon:t.jsx(B,{}),onClick:w,children:"新增应收"})]}),t.jsxs(E,{gutter:16,className:"mb-4",children:[t.jsx(r,{span:6,children:t.jsx(i,{children:t.jsx(l,{title:"应收总额",value:j,prefix:"¥",precision:2})})}),t.jsx(r,{span:6,children:t.jsx(i,{children:t.jsx(l,{title:"已收金额",value:h,prefix:"¥",precision:2,valueStyle:{color:"#3f8600"}})})}),t.jsx(r,{span:6,children:t.jsx(i,{children:t.jsx(l,{title:"待收金额",value:j-h,prefix:"¥",precision:2,valueStyle:{color:"#cf1322"}})})}),t.jsx(r,{span:6,children:t.jsx(i,{children:t.jsx(l,{title:"逾期金额",value:Y,prefix:"¥",precision:2,valueStyle:{color:"#cf1322"}})})})]}),t.jsx(i,{title:"账龄分析",className:"mb-4",children:t.jsx("div",{className:"grid grid-cols-4 gap-4",children:P.map(e=>t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-gray-500 mb-2",children:e.range}),t.jsxs("div",{className:"text-lg font-bold",children:["¥",Math.round(e.amount).toLocaleString()]})]},e.range))})}),t.jsx(i,{title:"应收明细",children:t.jsx(G,{columns:L,dataSource:o,rowKey:"id"})}),t.jsx(y,{title:"新增应收",open:k,onOk:T,onCancel:()=>d(!1),children:t.jsxs(n,{form:u,layout:"vertical",children:[t.jsx(n.Item,{name:"customerId",label:"客户",rules:[{required:!0}],children:t.jsx(H,{options:f.map(e=>({label:e.name,value:e.id}))})}),t.jsx(n.Item,{name:"invoiceNo",label:"发票号",rules:[{required:!0}],children:t.jsx(A,{})}),t.jsx(n.Item,{name:"amount",label:"金额",rules:[{required:!0}],children:t.jsx(N,{className:"w-full",prefix:"¥",precision:2})}),t.jsx(n.Item,{name:"dueDate",label:"到期日",rules:[{required:!0}],children:t.jsx(J,{className:"w-full"})}),t.jsx(n.Item,{name:"description",label:"描述",children:t.jsx(A.TextArea,{})})]})}),t.jsx(y,{title:"收款",open:F,onOk:$,onCancel:()=>c(!1),children:t.jsx(n,{form:m,layout:"vertical",children:t.jsx(n.Item,{name:"amount",label:"收款金额",rules:[{required:!0}],children:t.jsx(N,{className:"w-full",prefix:"¥",precision:2,min:0,max:s?s.amount-s.paidAmount:0})})})})]})}export{ie as default};
